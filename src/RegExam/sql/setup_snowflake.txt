CREATE WAREHOUSE IF NOT EXISTS RETAIL_ETL_WH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE;

CREATE DATABASE IF NOT EXISTS RETAIL_DB;

CREATE SCHEMA RETAIL_DB.STAGING_LAYER;
CREATE SCHEMA RETAIL_DB.CLEANSED_LAYER;
CREATE SCHEMA RETAIL_DB.BUSINESS_LAYER;
CREATE SCHEMA RETAIL_DB.PRESENTATION_LAYER;

CREATE FILE FORMAT RETAIL_DB.STAGING_LAYER.CSV_FORMAT
    TYPE = 'CSV'
    FIELD_DELIMITER = ','
    SKIP_HEADER = 1;
    
CREATE STAGE RETAIL_DB.STAGING_LAYER.RETAIL_S3_STAGE
    URL = 's3://iva-data-warehouse-10/RegExam/'
    CREDENTIALS = (
        AWS_KEY_ID = ''
        AWS_SECRET_KEY = ''
    )
    FILE_FORMAT = RETAIL_DB.STAGING_LAYER.CSV_FORMAT;

CREATE TABLE RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES(
    SALES_ID INT,
    PRODUCT_ID INT,
    REGION STRING,
    QUANTITY INT,
    PRICE NUMERIC(10, 2),
    TIMESTAMP DATE,
    DISCOUNT NUMERIC(10, 2),
    ORDER_STATUS STRING
);
    
CREATE TABLE RETAIL_DB.CLEANSED_LAYER.CLEANED_PRODUCTS(
    PRODUCT_ID INT,
    CATEGORY STRING,
    BRAND STRING,
    RATING NUMERIC(10, 2),
    IN_STOCK BOOLEAN,
    LAUNCH_DATE DATE
);

COPY INTO RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES
FROM @RETAIL_DB.STAGING_LAYER.RETAIL_S3_STAGE/Outputs/
FILES = ('cleaned_sales.csv')
ON_ERROR = CONTINUE;

SELECT * FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES;

COPY INTO RETAIL_DB.CLEANSED_LAYER.CLEANED_PRODUCTS
FROM @RETAIL_DB.STAGING_LAYER.RETAIL_S3_STAGE/Outputs/
FILES = ('cleaned_products.csv')
ON_ERROR = CONTINUE;

SELECT * FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_PRODUCTS;

CREATE OR REPLACE TABLE RETAIL_DB.BUSINESS_LAYER.MERGED_SALES_PRODUCTS AS
SELECT
    S.SALES_ID,
    S.PRODUCT_ID,
    S.REGION,
    S.QUANTITY,
    S.PRICE,
    S.TIMESTAMP,
    S.DISCOUNT,
    S.ORDER_STATUS,
    P.CATEGORY,
    P.BRAND,
    P.RATING,
    P.IN_STOCK,
    P.LAUNCH_DATE
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES S
JOIN RETAIL_DB.CLEANSED_LAYER.CLEANED_PRODUCTS P
ON S.PRODUCT_ID = P.PRODUCT_ID;

SELECT * FROM RETAIL_DB.BUSINESS_LAYER.MERGED_SALES_PRODUCTS;

--- MV_SALES_BY_REGION_MONTH

CREATE OR REPLACE MATERIALIZED VIEW RETAIL_DB.PRESENTATION_LAYER.MV_SALES_BY_REGION_MONTH AS
SELECT 
    REGION,
    DATE_TRUNC('MONTH', TIMESTAMP) AS SALES_MONTH,
    COUNT(SALES_ID) AS SALES_COUNT,
    SUM(QUANTITY) AS UNITS_SOLD,
    ROUND(SUM(PRICE * QUANTITY * (1 - DISCOUNT)), 2) AS TOTAL_REVENUE
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES
WHERE ORDER_STATUS = 'Completed'
GROUP BY REGION, SALES_MONTH;

SELECT * 
FROM RETAIL_DB.PRESENTATION_LAYER.MV_SALES_BY_REGION_MONTH
ORDER BY REGION, SALES_MONTH;

--- MV_TOP_PRODUCTS_BY_REVENUE

CREATE OR REPLACE MATERIALIZED VIEW RETAIL_DB.PRESENTATION_LAYER.MV_TOP_PRODUCTS_BY_REVENUE AS
SELECT 
    PRODUCT_ID,
    SUM(QUANTITY) AS UNITS_SOLD,
    ROUND(SUM(PRICE * QUANTITY * (1 - DISCOUNT)), 2) AS TOTAL_REVENUE
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES
GROUP BY PRODUCT_ID;

SELECT * FROM RETAIL_DB.PRESENTATION_LAYER.MV_TOP_PRODUCTS_BY_REVENUE
ORDER BY TOTAL_REVENUE DESC
LIMIT 5;

--- MV_REVENUE_TREND

CREATE OR REPLACE MATERIALIZED VIEW RETAIL_DB.PRESENTATION_LAYER.MV_REVENUE_TREND AS
SELECT
    REGION,
    DATE_TRUNC('MONTH', TIMESTAMP) AS SALES_MONTH,
    ROUND(SUM(QUANTITY * PRICE * (1 - DISCOUNT)), 2) AS TOTAL_REVENUE,
    SUM(QUANTITY) AS TOTAL_QUANTITY,
    COUNT(SALES_ID) AS ORDERS_COUNT
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES
WHERE ORDER_STATUS = 'Completed'
GROUP BY REGION, SALES_MONTH;

SELECT * 
FROM RETAIL_DB.PRESENTATION_LAYER.MV_REVENUE_TREND
ORDER BY REGION, SALES_MONTH;

--- MV_CATEGORY_PERFORMANCE

CREATE OR REPLACE MATERIALIZED VIEW RETAIL_DB.PRESENTATION_LAYER.MV_CATEGORY_PERFORMANCE AS
SELECT
    CATEGORY,
    REGION,
    DATE_TRUNC('MONTH', TIMESTAMP) AS SALES_MONTH,
    ROUND(SUM(QUANTITY * PRICE * (1 - DISCOUNT)), 2) AS TOTAL_REVENUE,
    SUM(QUANTITY) AS TOTAL_QUANTITY,
    ROUND(AVG(RATING), 2) AS AVG_RATING,
    COUNT(SALES_ID) AS ORDERS_COUNT
FROM RETAIL_DB.BUSINESS_LAYER.MERGED_SALES_PRODUCTS
WHERE ORDER_STATUS = 'Completed'
GROUP BY CATEGORY, REGION, SALES_MONTH;

SELECT * 
FROM RETAIL_DB.PRESENTATION_LAYER.MV_CATEGORY_PERFORMANCE
ORDER BY CATEGORY, REGION, SALES_MONTH;


--- Build Star Schema 

CREATE OR REPLACE TABLE RETAIL_DB.BUSINESS_LAYER.DIM_DATE(
    DATE_ID INT PRIMARY KEY, 
    FULL_DATE DATE NOT NULL, 
    YEAR INT NOT NULL, 
    QUARTER INT NOT NULL, 
    MONTH INT NOT NULL,
    MONTH_NAME VARCHAR(20) NOT NULL,
    DAY INT NOT NULL, 
    WEEKDAY_NAME VARCHAR(10) NOT NULL
);

INSERT INTO RETAIL_DB.BUSINESS_LAYER.DIM_DATE (DATE_ID, FULL_DATE, YEAR, QUARTER, MONTH, 
                                                    MONTH_NAME, DAY, WEEKDAY_NAME) 
SELECT DISTINCT 
    TO_CHAR(TIMESTAMP, 'YYYYMMDD')::INT AS DATE_ID, 
    DATE(TIMESTAMP), 
    EXTRACT(YEAR FROM TIMESTAMP),
    EXTRACT(QUARTER FROM TIMESTAMP),
    EXTRACT(MONTH FROM TIMESTAMP),
    MONTHNAME(TIMESTAMP),
    EXTRACT(DAY FROM TIMESTAMP),
    DAYNAME(TIMESTAMP)
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES;

SELECT * FROM RETAIL_DB.BUSINESS_LAYER.DIM_DATE;

CREATE TABLE RETAIL_DB.BUSINESS_LAYER.DIM_PRODUCT(
    PRODUCT_ID INT PRIMARY KEY
);

INSERT INTO RETAIL_DB.BUSINESS_LAYER.DIM_PRODUCT (PRODUCT_ID) 
SELECT DISTINCT 
    PRODUCT_ID 
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES;

SELECT * FROM RETAIL_DB.BUSINESS_LAYER.DIM_PRODUCT;

CREATE TABLE RETAIL_DB.BUSINESS_LAYER.FACT_SALES (
    SALES_ID INT PRIMARY KEY, 
    PRODUCT_ID INT, 
    DATE_ID INT, 
    REGION VARCHAR(50), 
    QUANTITY INT, 
    PRICE DECIMAL(10,2), 
    DISCOUNT DECIMAL(5,2), 
    ORDER_STATUS VARCHAR(20), 
    FOREIGN KEY (PRODUCT_ID) REFERENCES RETAIL_DB.BUSINESS_LAYER.DIM_PRODUCT(PRODUCT_ID), 
    FOREIGN KEY (DATE_ID) REFERENCES RETAIL_DB.BUSINESS_LAYER.DIM_DATE(DATE_ID) 
);

INSERT INTO RETAIL_DB.BUSINESS_LAYER.FACT_SALES (SALES_ID, PRODUCT_ID, DATE_ID, REGION, 
                                                    QUANTITY, PRICE, DISCOUNT, ORDER_STATUS)
SELECT 
    SALES_ID, 
    PRODUCT_ID, 
    TO_CHAR(TIMESTAMP, 'YYYYMMDD')::INT AS DATE_ID, 
    REGION, 
    QUANTITY, 
    PRICE, 
    DISCOUNT, 
    ORDER_STATUS 
FROM RETAIL_DB.CLEANSED_LAYER.CLEANED_SALES;

SELECT * FROM RETAIL_DB.BUSINESS_LAYER.FACT_SALES;
